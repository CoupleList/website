<!doctype html>
<html class="uk-height-1-1">

<head>
    <meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>Couple List</title>

    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.0-beta.28/css/uikit.min.css" />

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.0-beta.28/js/uikit.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.0-beta.28/js/uikit-icons.min.js"></script>

    <script src="/__/firebase/5.0.4/firebase-app.js"></script>
    <script src="/__/firebase/5.0.4/firebase-auth.js"></script>
    <script src="/__/firebase/5.0.4/firebase-database.js"></script>
    <script src="/__/firebase/init.js"></script>

    <style>
        #page,
        #lander {
            height: 100%;
            width: 100%;
            display: table;
        }

        #page>div {
            width: 90%;
            padding: 1%;
            margin-left: 5%;
        }

        #authenticator {
            display: table-cell;
            height: 100%;
            vertical-align: middle;
        }

        #authenticator>form>*,
        #authenticator>form>div>button {
            width: 85%;
            margin-left: 7.5%;
        }

        #content {
            display: table-cell;
            height: 100%;
            vertical-align: middle;
        }

        #content>div {
            width: 100%;
        }

        #content>div>* {
            text-align: center;
        }

        #content>div>div {
            width: 50%;
            margin-left: 25%;
        }

        #activities {
            max-height: 40vh;
            overflow-y: scroll;
        }

        #footer {
            width: 100%;
        }

        #footer>p {
            width: 100%;
            text-align: center;
        }

        li>* {
            width: 90%;
            margin-left: 5% !important;
        }
    </style>

    <script type="text/javascript">
        var ref;
        var uid;
        var list;

        firebase.auth().onAuthStateChanged(function(user) {
            if (user) {
                uid = user.uid;
                $('#authenticator').prop('hidden', true);
                $('#list').removeAttr('hidden');
                $('#footer-text').append('&emsp;&emsp;&emsp;&emsp;<a onclick="logoutUser();">logout</a>');
                checkForList();
                scrollToPage();
            } else {
                $('#authenticator').removeAttr('hidden');
                $('#list').prop('hidden', true);
                $('#footer-text').html('<a href="http://www.kirinpatel.com" target="_blank">more of my work</a>&emsp;&emsp;&emsp;&emsp;<a href="https://github.com/ajchili/couple-list-web/blob/master/README.md" target="_blank">info</a>&emsp;&emsp;&emsp;&emsp;<a href="./privacy">privacy policy</a>');
                if (ref != null) {
                    ref.off;
                }
                uid = null;
                setButtonVisibility(0);
            }
        });

        function scrollToPage() {
            $('html, body').animate({
                scrollTop: $('#page').offset().top
            }, 'slow');
        }

        function loginUser() {
            var email = $('#email_address');
            var password = $('#password');

            if (email.val().length > 0 && password.val().length > 0) {
                firebase.auth().signInWithEmailAndPassword(email.val(), password.val()).catch(function(error) {
                    UIkit.modal.alert(error.message);
                });
            } else {
                UIkit.modal.alert("An email address and password are required to login!");
                if (email.val().length <= 0) {
                    email.addClass("uk-form-danger");
                }
                if (password.val().length <= 0) {
                    password.addClass("uk-form-danger");
                }
            }
        }

        function registerUser() {
            var email = $('#email_address');
            var password = $('#password');

            if (email.val().length > 0 && password.val().length > 0) {
                if (password.val().length < 8) {
                    UIkit.modal.alert("Your password must be 8 characters or longer!");
                    password.addClass("uk-form-danger");
                } else {
                    email.removeClass("uk-form-danger");
                    password.removeClass("uk-form-danger");
                    firebase.auth().createUserWithEmailAndPassword(email.val(), password.val()).catch(function(error) {
                        UIkit.modal.alert(error.message);
                    });
                }
            } else {
                UIkit.modal.alert("An email address and password are required to register!");
                if (email.val().length <= 0) {
                    email.addClass("uk-form-danger");
                }
                if (password.val().length <= 0) {
                    password.addClass("uk-form-danger");
                }
            }
        }

        function resetUserPassword() {
            var email = $('#email_address');

            if (email.val().length > 0) {
                firebase.auth().sendPasswordResetEmail(email.val()).then(function() {
                    UIkit.modal.alert("Password reset email sent!");
                }).catch(function(error) {
                    UIkit.modal.alert(error.message);
                });
            } else {
                UIkit.modal.alert("An email address is required to send a password reset email!");
                email.addClass("uk-form-danger");
            }
        }

        function logoutUser() {
            scrollToPage();
            firebase.auth().signOut().catch(function(error) {
                UIkit.modal.alert(error.message);
            });
        }

        function setButtonVisibility(visibility) {
            if (visibility == 0) {
                $('#generate_list').prop('hidden', true);
                $('#load_list').prop('hidden', true);
                $('#leave_list').removeAttr('hidden');
                $('#share_list').removeAttr('hidden');
                $('#add').removeAttr('hidden');
            } else {
                $('#generate_list').removeAttr('hidden');
                $('#load_list').removeAttr('hidden');
                $('#leave_list').prop('hidden', true);
                $('#share_list').prop('hidden', true);
                $('#add').prop('hidden', true);
            }
        }

        function checkForList() {
            firebase.database().ref('/users/' + uid + '/').once('value').then(function(snapshot) {
                if (snapshot.val() != null) {
                    setButtonVisibility(0);
                    loadActivities();
                    window.history.pushState(null, null, window.location.href.substring(window.location.href.lastIndexOf('/') + 1).split("?")[0]);
                } else {
                    var list = window.location.href.substring(window.location.href.lastIndexOf('/') + 1).split("?")[1].substring(5, window.location.href.substring(window.location.href.lastIndexOf('/') + 1).split("?")[1].length);
                    var code = window.location.href.substring(window.location.href.lastIndexOf('/') + 1).split("?")[2].substring(4, window.location.href.substring(window.location.href.lastIndexOf('/') + 1).split("?")[2].length);
                    if (uid != null && list != null && code != null) {
                        firebase.database().ref('users/' + uid + '/' + list + '/code/').set(code);
                        setButtonVisibility(0);
                        loadActivities();
                        window.history.pushState(null, null, window.location.href.substring(window.location.href.lastIndexOf('/') + 1).split("?")[0]);
                    }
                }
            });
        }

        function generateList() {
            var listKey = firebase.database().ref('/lists/').push().key;
            setTimeout(function() {
                var listCode = firebase.database().ref('users/' + uid + '/' + listKey + '/').push().key;

                firebase.database().ref('users/' + uid + '/' + listKey + '/').set({
                    code: listCode
                });
                firebase.database().ref('lists/' + listKey + '/').set({
                    code: listCode
                });

                checkForList();
            }, 500);
        }

        function shareList() {
            firebase.database().ref('users/' + uid + '/').once('value').then(function(snapshot) {
                snapshot.forEach(function(childSnapshot) {
                    UIkit.modal.dialog('<p class="uk-text-center uk-modal-body">Please share <a href="http://couplelist.kirinpatel.com?list=' + childSnapshot.key + '?key=' + childSnapshot.child('code').val() + '">this link</a> with your significant other.<br>Don\'t forget to tell them to log in!</p>');
                });
            });
        }

        function loadActivities() {
            firebase.database().ref('users/' + uid + '/').once('value').then(function(snapshot) {
                snapshot.forEach(function(childSnapshot) {
                    list = childSnapshot.key
                    ref = firebase.database().ref('lists/' + childSnapshot.key + '/activities/');
                    ref.on('value', function(childChildSnapshot) {
                        var items = "";
                        $('#activities').empty();

                        childChildSnapshot.forEach(function(childChildChildSnapshot) {
                            var activity = {
                                key: childChildChildSnapshot.key,
                                title: childChildChildSnapshot.child('title').val(),
                                description: childChildChildSnapshot.child('description').val(),
                                done: childChildChildSnapshot.child('done').val()
                            };

                            if (childChildChildSnapshot.child('done').val()) {
                                items = items + "<li id=\"" + childChildChildSnapshot.key + "\" class=\"uk-alert-success\"><h3 class=\"uk-accordion-title\">" + childChildChildSnapshot.child('title').val() + "</h3><div class=\"uk-accordion-content\"><p>" + childChildChildSnapshot.child('description').val() + "</p><div class=\"uk-margin\"><div class=\"uk-margin\" style=\"float: right;\"><button id=\"delete\" class=\"uk-button uk-alert-danger\" onclick=\"deleteActivity('" + childChildChildSnapshot.key + "');\">delete</button></div></div></div></div></li>";
                            } else {
                                items = items + "<li id=\"" + childChildChildSnapshot.key + "\"><h3 class=\"uk-accordion-title\">" + childChildChildSnapshot.child('title').val() + "</h3><div class=\"uk-accordion-content\"><p>" + childChildChildSnapshot.child('description').val() + "</p><div class=\"uk-margin\"><button id=\"edit\" class=\"uk-button uk-button-secondary\" onclick=\"editActivity('" + childChildChildSnapshot.key + "', '" + childChildChildSnapshot.child('title').val() + "', '" + childChildChildSnapshot.child('description').val() + "');\">edit</button><div style=\"float: right;\"><button id=\"delete\" class=\"uk-button uk-alert-success\" onclick=\"finishActivity('" + childChildChildSnapshot.key + "');\">mark as completed</button><button id=\"delete\" class=\"uk-button uk-alert-danger\" onclick=\"deleteActivity('" + childChildChildSnapshot.key + "');\">delete</button></div></div></div></li>";
                            }
                            $('#activities').html(items);
                        });
                    });
                });
            });
        }

        function addActivity(title, description) {
            title.removeClass("uk-form-danger");
            description.removeClass("uk-form-danger");

            if (title.val().length > 0 && description.val().length > 0) {
                firebase.database().ref('users/' + uid + '/').once('value').then(function(snapshot) {
                    snapshot.forEach(function(childSnapshot) {
                        var activityKey = firebase.database().ref('lists/' + childSnapshot.key + '/activities/').push().key;
                        firebase.database().ref('lists/' + childSnapshot.key + '/activities/' + activityKey).set({
                            title: title.val(),
                            description: description.val(),
                            done: false
                        });

                        title.val("");
                        description.val("");
                    });
                });
            } else {
                if (title.val().length <= 0) {
                    title.addClass("uk-form-danger");
                }

                if (description.val().length <= 0) {
                    description.addClass("uk-form-danger");
                }

                UIkit.modal.alert("A title and description are needed to create an activity!");
            }
        }

        function editActivity(activityKey, title, description) {
            $('#' + activityKey).replaceWith('<li id="' + activityKey + '" class="uk-open uk-alert-primary"><h3 class="uk-accordion-title">Edit ' + title + '</h3><div class="uk-accordion-content"><div style="margin-left: 5%; width: 90%;"><form><div class="uk-margin"><input id="edit_activity_title" class="uk-input" type="text" placeholder="Activity Title" value="' + title + '"></div><div class="uk-margin"><input id="edit_activity_description" class="uk-input" type="text" placeholder="Activity Description" value="' + description + '"></div></form><div class="uk-margin"><div><button id="Save" class="uk-button uk-button-secondary" type="button">Save</button><button class="uk-button uk-button-secondary" type="button" style="float: right;" onclick="loadActivities();">Cancel</button></div></div></div></div></li>');

            $('#Save').click(function() {
                $('#edit_activity_title').addClass("uk-form-danger");
                $('#edit_activity_description').removeClass("uk-form-danger");

                if ($('#edit_activity_title').val().length > 0 && $('#edit_activity_description').val().length > 0) {
                    firebase.database().ref('users/' + uid + '/').once('value').then(function(snapshot) {
                        snapshot.forEach(function(childSnapshot) {
                            firebase.database().ref('lists/' + childSnapshot.key + '/activities/' + activityKey).update({
                                title: $('#edit_activity_title').val(),
                                description: $('#edit_activity_description').val(),
                                done: false
                            });
                        });
                    });
                } else {
                    if ($('#edit_activity_title').val().length <= 0) {
                        $('#edit_activity_title').addClass("uk-form-danger");
                    }

                    if ($('#edit_activity_description').val().length <= 0) {
                        $('#edit_activity_description').addClass("uk-form-danger");
                    }

                    UIkit.modal.alert("A title and description are needed to edit an activity!");
                }
            })
        }

        function deleteActivity(activityKey) {
            UIkit.modal.confirm("Are you sure that you want to delete this activity?").then(function() {
                firebase.database().ref('users/' + uid + '/').once('value').then(function(snapshot) {
                    snapshot.forEach(function(childSnapshot) {
                        firebase.database().ref('lists/' + childSnapshot.key + '/activities/' + activityKey).remove();
                    });
                });
            }, function() {

            });
        }

        function finishActivity(activityKey) {
            UIkit.modal.confirm("Are you sure that you want to finish this activity?").then(function() {
                firebase.database().ref('users/' + uid + '/').once('value').then(function(snapshot) {
                    snapshot.forEach(function(childSnapshot) {
                        firebase.database().ref('lists/' + childSnapshot.key + '/activities/' + activityKey).child('done').set(true);
                    });
                });
            }, function() {

            });
        }

        function leaveList() {
            UIkit.modal.confirm("Are you sure that you want to leave your Couple List?").then(function() {
                firebase.database().ref('lists/' + list + '/tokens/' + uid).remove();
                firebase.database().ref('users/' + uid).remove();
                $('#activities').empty();
                setButtonVisibility(1);
            }, function() {

            });
        }
    </script>
</head>

<body class="uk-height-1-1">

    <div id="lander" class="uk-section uk-section-secondary">
        <div id="content">
            <div class="uk-animation-scale-down">
                <h1 class="uk-animation-fade">Couple List</h1>
                <p class="uk-animation-fade">A bucket list for couples;<br><a href="#page" uk-scroll>scroll down</a> to create, edit, or view yours.</p>
            </div>
        </div>
    </div>

    <div id="page" class="uk-section uk-section-muted">
        <div id="authenticator" class="uk-card uk-card-default">
            <form>
                <div class="uk-margin">
                    <input id="email_address" class="uk-input" type="text" placeholder="Email Address">
                </div>
                <div class="uk-margin">
                    <input id="password" class="uk-input" type="password" placeholder="Password">
                </div>
                <div class="uk-margin">
                    <button id="login" class="uk-button uk-button-secondary" type="button" onclick="loginUser();">Login</button>
                </div>
                <div class="uk-margin">
                    <button id="register" class="uk-button uk-button-secondary" type="button" onclick="registerUser();">Register</button>
                </div>
                <div class="uk-margin">
                    <button id="reset_password" class="uk-button uk-button-secondary" type="button" onclick="resetUserPassword();">Reset Password</button>
                </div>
            </form>
        </div>
        <div id="list" class="uk-card uk-card-default" hidden>
            <form>
                <div class="uk-margin">
                    <button id="generate_list" class="uk-button uk-button-secondary" type="button" onclick="generateList();">Generate New List</button>
                    <button id="leave_list" class="uk-button uk-button-danger" type="button" onclick="leaveList();" hidden>Leave List</button>
                    <button id="share_list" class="uk-button uk-button-secondary" type="button" style="float: right;" onclick="shareList();" hidden>Share List</button>
                </div>
            </form>
            <ul id="activities" uk-accordion>
            </ul>
            <form id="add" hidden>
                <div class="uk-margin">
                    <input id="activity_title" class="uk-input" type="text" placeholder="Activity Title">
                </div>
                <div class="uk-margin">
                    <textarea id="activity_description" class="uk-input uk-textarea" type="text" placeholder="Activity Description"></textarea>
                </div>
                <div class="uk-margin">
                    <button class="uk-button uk-button-secondary" type="button" onclick="addActivity($('#activity_title'), $('#activity_description'));">Add</button>
                </div>
            </form>
        </div>
    </div>

    <div id="footer" class="uk-section uk-section-secondary">
        <p id="footer-text">
            <a href="http://www.kirinpatel.com" target="_blank">more of my work</a>&emsp;&emsp;&emsp;&emsp;
            <a href="https://github.com/ajchili/couple_list/blob/master/README.md" target="_blank">info</a>&emsp;&emsp;&emsp;&emsp;
            <a href="./privacy">privacy policy</a>
        </p>
    </div>
</body>

</html>
